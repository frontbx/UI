{"version":3,"names":["root","FBX_ROOT","process","global","window","LAZY_FALLBACK_IMAGE","Queue","concurrency","this","running","taskQueue","prototype","add","task","_runTask","_enqueueTask","next","length","shift","push","LazyLoad","_DOMElements","construct","document","context","_queue","nodes","Array","slice","call","querySelectorAll","i","bind","destruct","each","closest","frontbx","import","from","DOMElement","splice","node","url","_getSrc","_canLoad","_loadImage","_isImage","isImage","src","_markLoaded","_getLoadFunc","_this","_fallback","queue","_image","Image","onload","style","backgroundImage","onerror","_markFailed","classList","remove","getAttribute","dataset","contains","nodeName","toLowerCase","addEventListener","lazy","dom","register"],"sources":["dist/js/frontbx-lazyload.js"],"sourcesContent":["/**\n * --------------------------------------------------------------------------\n * Frontbx Lazyload\n * \n * @version  {0.0.4}\n * @see      {https://github.com/frontbx/ui}\n * @licensed {https://github.com/frontbx/ui/blob/main/LICENSE}\n * --------------------------------------------------------------------------\n */\n(function()\n{\n\n    var root = typeof FBX_ROOT === 'undefined' ? (typeof process === 'object' && typeof global === 'object' ? global : window) : FBX_ROOT;\n\n    if (!root.LAZY_FALLBACK_IMAGE)\n    {\n        root.LAZY_FALLBACK_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiIgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJ3aGl0ZSI+CiAgPHBhdGggZD0iTTAgNCBMMCAyOCBMMzIgMjggTDMyIDQgeiBNNCAyNCBMMTAgMTAgTDE1IDE4IEwxOCAxNCBMMjQgMjR6IE0yNSA3IEE0IDQgMCAwIDEgMjUgMTUgQTQgNCAwIDAgMSAyNSA3Ij48L3BhdGg+Cjwvc3ZnPg==';\n    }\n\n    /**\n     * JS Async Queue\n     *\n     * @see https://medium.com/@griffinmichl/asynchronous-javascript-queue-920828f6327\n     */\n    var Queue = function(concurrency)\n    {\n        this.running     = 0;\n        this.concurrency = concurrency;\n        this.taskQueue   = [];\n        \n        return this;\n    }\n\n    Queue.prototype.add = function(task)\n    {\n        if (this.running < this.concurrency)\n        {\n            this._runTask(task);\n        }\n        else\n        {\n            this._enqueueTask(task);\n        }\n    }\n\n    Queue.prototype.next = function()\n    {        \n        this.running--;\n\n        if (this.taskQueue.length > 0)\n        {\n            this._runTask(this.taskQueue.shift());\n        }\n    }\n\n    Queue.prototype._runTask = function(task)\n    {       \n        this.running++;\n\n        task(this);\n    }\n\n    Queue.prototype._enqueueTask = function(task)\n    {\n        this.taskQueue.push(task);\n    }\n\n    /**\n     * Module constructor\n     *\n     * @access public\n     * @constructor\n     * @return this\n     */\n    const LazyLoad = function()\n    {\n        this._DOMElements = [];\n\n        this.construct(document);       \n\n        return this;\n    }\n\n    /**\n     * Destroy\n     *\n     * @access public\n     */\n    LazyLoad.prototype.construct = function(context)\n    {               \n        this._queue = new Queue(15);\n\n        let nodes = Array.prototype.slice.call(context.querySelectorAll('.js-lazyload'));\n\n        if (nodes.length >= 1)\n        {\n            for (var i = 0; i < nodes.length; i++)\n            {\n                this.bind(nodes[i]);\n            }\n\n            this._DOMElements = [...this._DOMElements, ...nodes];\n        }\n    }\n\n    /**\n     * Destroy\n     *\n     * @access public\n     */\n    LazyLoad.prototype.destruct = function(context)\n    {       \n        if (!context || context === document)\n        {            \n            this._DOMElements = [];\n\n            return;\n        }\n\n        const [each, closest] = frontbx.import(['each', 'closest']).from('_');\n\n        each(this._DOMElements, function(i, DOMElement)\n        {                \n            if (closest(DOMElement, context))\n            {\n                this._DOMElements.splice(i, 1);\n            }\n\n        }, this);\n    }\n\n    /**\n     * Bind and load images\n     *\n     * @access private\n     */\n    LazyLoad.prototype.bind = function(node)\n    {\n        var url = this._getSrc(node);\n\n        if (this._canLoad(node))\n        {\n            this._loadImage(node, url, this._isImage(node));\n        }\n    }\n\n    /**\n     * Bind and load images\n     *\n     * @access private\n     * @param  node    node    DOM node\n     * @param  string  url     The image URL to load\n     * @param  bool    isImage Is the node an <img> tag\n     */\n    LazyLoad.prototype._loadImage = function(node, url, isImage)\n    {\n        // Placeholder and image are the same\n        if (isImage && node.src === url)\n        {\n            this._markLoaded(node);\n        }\n        else\n        {\n            this._queue.add(this._getLoadFunc(node, url, isImage));\n        }\n    }\n\n    /**\n     * Return the image load function\n     *\n     * @access private\n     * @param  node    node       DOM node\n     * @param  string  url        The image URL to load\n     * @param  bool    isImage    Is the node an <img> tag?\n     * @return function\n     */\n    LazyLoad.prototype._getLoadFunc = function(node, url, isImage)\n    {\n        const _this = this;\n\n        let _fallback = LAZY_FALLBACK_IMAGE;\n\n        return function loadImage(queue)\n        {\n            var _image = new Image();\n\n            _image.onload = function()\n            {\n                if (isImage)\n                {\n                    node.src = url;\n                }\n                else\n                {\n                    node.style.backgroundImage = 'url('+ url +')';\n                }\n\n                _this._markLoaded(node);\n\n                _image.onload  = {};\n                _image.onerror = {};\n                \n                queue.next();\n            };\n\n            _image.onerror = function()\n            {\n                if (isImage)\n                {\n                    node.src = _fallback;\n                }\n                else\n                {\n                    node.style.backgroundImage = `url(\"${_fallback}\")`;\n                }\n\n                _this._markFailed(node);\n\n                queue.next();\n\n                _image.onload  = {};\n                _image.onerror = {};\n            };\n\n            _image.classList.add('lazy-loading');\n\n            _image.src = url;\n        };\n    }\n\n    /**\n     * Mark node as loaded\n     *\n     * @access private\n     * @param  node    node Image node element\n     * @return string\n     */\n    LazyLoad.prototype._markFailed = function(node)\n    {\n        node.classList.add('failed');\n\n        this._markLoaded(node);\n    }\n\n    /**\n     * Mark node as loaded\n     *\n     * @access private\n     * @param  node    node Image node element\n     * @return string\n     */\n    LazyLoad.prototype._markLoaded = function(node)\n    {\n        node.classList.add('lazy-loaded');\n\n        node.classList.remove('lazy-loading');\n    }\n\n    /**\n     * Get an image's src attribute\n     *\n     * @access private\n     * @param  node    node Image node element\n     * @return string\n     */\n    LazyLoad.prototype._getSrc = function(node)\n    {\n        return node.getAttribute('data-src') || node.dataset.src;\n    }\n\n    /**\n     * Should we load this image\n     *\n     * @access private\n     * @param  node    node Image node element\n     * @return bool\n     */\n    LazyLoad.prototype._canLoad = function(node)\n    {\n        return typeof this._getSrc(node) !== 'undefined' && (!node.classList.contains('lazy-loading') || !node.classList.contains('lazy-loaded'));\n    }\n\n    /**\n     * Is node an image\n     *\n     * @access private\n     * @param  node    node Image node element\n     * @return bool\n     */\n    LazyLoad.prototype._isImage = function(node)\n    {\n        return node.nodeName.toLowerCase() === 'img';\n    }\n\n    if (!root.frontbx)\n    {\n        window.addEventListener('DOMContentLoaded', () =>\n        {\n            // Invoke and start loading images\n            const lazy = new LazyLoad();\n\n            // Listen for frontbx:ready and register into dom\n            // Will not be invoked unless dom().refresh() is called\n            frontbx.dom().register('LazyLoad', lazy, false);\n        })\n    }\n    \n})();\n"],"mappings":"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","ignoreList":[]}